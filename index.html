<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weer in Zeist - Spectaculaire Lucht</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .sky-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c1445;
            transition: background 2s ease;
        }

        .sky-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .weather-info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .current-weather {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .temp-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .temperature {
            font-size: 48px;
            font-weight: 200;
        }

        .weather-icon {
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .details-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .location {
            font-size: 18px;
            font-weight: 300;
            opacity: 0.9;
        }

        .description {
            font-size: 16px;
            opacity: 0.8;
            text-transform: capitalize;
        }

        .weather-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .wind-arrow {
            transform-origin: center;
            transition: transform 0.5s ease;
        }

        .time-scrubber {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            padding: 20px;
            z-index: 100;
        }

        .time-display {
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: 300;
            margin-bottom: 15px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .live-indicator {
            color: #4CAF50;
            font-weight: 500;
        }

        .slider-container {
            position: relative;
            margin-bottom: 15px;
        }

        .time-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .time-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .hour-markers {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-top: 8px;
        }

        .hourly-temps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .hourly-temp {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            gap: 2px;
        }

        .hourly-temp .temp {
            font-weight: 500;
        }

        .hourly-temp .time {
            opacity: 0.7;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .particles-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        @media (max-width: 768px) {
            .weather-info {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .current-weather {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .temperature {
                font-size: 36px;
            }
            
            .weather-details {
                gap: 10px;
            }
            
            .time-scrubber {
                padding: 15px;
            }
            
            .hourly-temps {
                overflow-x: auto;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="sky-container" id="skyContainer">
        <canvas class="sky-canvas" id="skyCanvas"></canvas>
        <canvas class="particles-canvas" id="particlesCanvas"></canvas>
    </div>

    <div class="loading" id="loading">Weerdata laden...</div>

    <div class="weather-info" id="weatherInfo" style="display: none;">
        <div class="current-weather">
            <div class="temp-section">
                <div class="temperature" id="temperature">-¬∞</div>
                <div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
            </div>
            <div class="details-section">
                <div class="location">Zeist, Nederland</div>
                <div class="description" id="description">-</div>
            </div>
        </div>
        <div class="weather-details">
            <div class="detail-item">
                <span>üå°Ô∏è</span>
                <span id="feelsLike">Voelt als -¬∞</span>
            </div>
            <div class="detail-item">
                <span class="wind-arrow" id="windArrow">‚Üë</span>
                <span id="wind">- km/h</span>
            </div>
            <div class="detail-item">
                <span>üíß</span>
                <span id="humidity">-%</span>
            </div>
            <div class="detail-item">
                <span>‚òÅÔ∏è</span>
                <span id="cloudCover">-%</span>
            </div>
        </div>
    </div>

    <div class="time-scrubber" id="timeScrubber" style="display: none;">
        <div class="time-display" id="timeDisplay">
            <span class="live-indicator" id="liveIndicator">üî¥ LIVE</span> 
            <span id="selectedTime">Nu</span>
        </div>
        
        <div class="slider-container">
            <input type="range" min="0" max="23" step="1" value="12" class="time-slider" id="timeSlider">
            <div class="hour-markers">
                <span>00</span><span>06</span><span>12</span><span>18</span><span>24</span>
            </div>
        </div>
        
        <div class="hourly-temps" id="hourlyTemps"></div>
    </div>

    <script>
        // Weather descriptions and icons
        const weatherDescriptions = {
            0: 'Helder', 1: 'Overwegend helder', 2: 'Gedeeltelijk bewolkt', 3: 'Bewolkt',
            45: 'Mist', 48: 'Ijsmist', 51: 'Lichte motregen', 53: 'Matige motregen', 55: 'Dichte motregen',
            56: 'Lichte ijzel', 57: 'Dichte ijzel', 61: 'Lichte regen', 63: 'Matige regen', 65: 'Zware regen',
            66: 'Lichte ijsregen', 67: 'Zware ijsregen', 71: 'Lichte sneeuw', 73: 'Matige sneeuw', 75: 'Zware sneeuw',
            77: 'Sneeuwkorrels', 80: 'Lichte buien', 81: 'Matige buien', 82: 'Zware buien',
            85: 'Lichte sneeuwbuien', 86: 'Zware sneeuwbuien', 95: 'Onweer', 96: 'Onweer met hagel', 99: 'Zwaar onweer met hagel'
        };

        const weatherIcons = {
            0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
            51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üå¶Ô∏è', 56: 'üå®Ô∏è', 57: 'üå®Ô∏è',
            61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è', 66: 'üåßÔ∏è', 67: 'üåßÔ∏è',
            71: '‚ùÑÔ∏è', 73: '‚ùÑÔ∏è', 75: '‚ùÑÔ∏è', 77: '‚ùÑÔ∏è', 80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
            85: 'üå®Ô∏è', 86: 'üå®Ô∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
        };

        // Global variables
        let weatherData = null;
        let skyCanvas, skyCtx, particlesCanvas, particlesCtx;
        let animationFrame = null;
        let isLiveMode = true;
        let selectedHour = new Date().getHours();
        let clouds = [];
        let stars = [];
        let particles = [];

        // Sky color palettes for different times
        const skyColors = {
            night: [
                { pos: 0, color: [12, 20, 69] },      // Deep navy top
                { pos: 0.3, color: [26, 35, 126] },   // Navy blue
                { pos: 0.7, color: [44, 56, 126] },   // Lighter blue
                { pos: 1, color: [63, 81, 181] }      // Horizon blue
            ],
            dawn: [
                { pos: 0, color: [25, 32, 91] },      // Dark blue-purple top
                { pos: 0.2, color: [123, 39, 162] },  // Purple
                { pos: 0.5, color: [244, 67, 54] },   // Pink-red  
                { pos: 0.8, color: [255, 152, 0] },   // Orange
                { pos: 1, color: [255, 235, 59] }     // Yellow horizon
            ],
            morning: [
                { pos: 0, color: [116, 185, 255] },   // Light blue top
                { pos: 0.3, color: [129, 199, 255] }, // Lighter blue
                { pos: 0.7, color: [187, 222, 251] }, // Very light blue
                { pos: 1, color: [227, 242, 253] }    // Almost white horizon
            ],
            day: [
                { pos: 0, color: [30, 136, 229] },    // Deep sky blue top
                { pos: 0.4, color: [66, 165, 245] },  // Sky blue
                { pos: 0.8, color: [144, 202, 249] }, // Light sky blue
                { pos: 1, color: [187, 222, 251] }    // Pale blue horizon
            ],
            sunset: [
                { pos: 0, color: [13, 71, 161] },     // Deep blue top
                { pos: 0.2, color: [103, 58, 183] },  // Purple
                { pos: 0.4, color: [233, 30, 99] },   // Pink
                { pos: 0.7, color: [255, 87, 34] },   // Red-orange
                { pos: 0.9, color: [255, 193, 7] },   // Orange
                { pos: 1, color: [255, 235, 59] }     // Yellow horizon
            ],
            dusk: [
                { pos: 0, color: [26, 35, 126] },     // Navy blue top
                { pos: 0.3, color: [69, 39, 160] },   // Purple
                { pos: 0.7, color: [156, 39, 176] },  // Pink-purple
                { pos: 1, color: [255, 152, 0] }      // Orange horizon glow
            ]
        };

        // Initialize the app
        async function init() {
            setupCanvas();
            await fetchWeatherData();
            setupTimeSlider();
            createStars();
            createClouds();
            startAnimationLoop();
            
            // Auto-refresh every 10 minutes
            setInterval(fetchWeatherData, 10 * 60 * 1000);
        }

        // Setup canvas
        function setupCanvas() {
            skyCanvas = document.getElementById('skyCanvas');
            skyCtx = skyCanvas.getContext('2d');
            particlesCanvas = document.getElementById('particlesCanvas');
            particlesCtx = particlesCanvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            [skyCanvas, particlesCanvas].forEach(canvas => {
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                canvas.getContext('2d').scale(dpr, dpr);
            });
        }

        // Fetch weather data
        async function fetchWeatherData() {
            try {
                const response = await fetch(
                    'https://api.open-meteo.com/v1/forecast?latitude=52.09&longitude=5.23&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m&hourly=temperature_2m,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m&daily=sunrise,sunset&timezone=Europe/Amsterdam&forecast_days=2'
                );
                
                weatherData = await response.json();
                updateWeatherDisplay();
                updateHourlyTemps();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('weatherInfo').style.display = 'block';
                document.getElementById('timeScrubber').style.display = 'block';
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('loading').textContent = 'Fout bij laden weerdata';
            }
        }

        // Update weather display
        function updateWeatherDisplay() {
            if (!weatherData) return;

            const dataIndex = isLiveMode ? 0 : selectedHour;
            const current = isLiveMode ? weatherData.current : {
                temperature_2m: weatherData.hourly.temperature_2m[selectedHour],
                apparent_temperature: weatherData.hourly.temperature_2m[selectedHour] - 2,
                weather_code: weatherData.hourly.weather_code[selectedHour],
                cloud_cover: weatherData.hourly.cloud_cover[selectedHour],
                wind_speed_10m: weatherData.hourly.wind_speed_10m[selectedHour],
                wind_direction_10m: weatherData.hourly.wind_direction_10m[selectedHour],
                relative_humidity_2m: weatherData.current.relative_humidity_2m
            };

            document.getElementById('temperature').textContent = `${Math.round(current.temperature_2m)}¬∞`;
            document.getElementById('feelsLike').textContent = `Voelt als ${Math.round(current.apparent_temperature)}¬∞`;
            document.getElementById('description').textContent = weatherDescriptions[current.weather_code] || 'Onbekend';
            document.getElementById('weatherIcon').textContent = weatherIcons[current.weather_code] || '‚ùì';
            
            document.getElementById('wind').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            document.getElementById('windArrow').style.transform = `rotate(${current.wind_direction_10m + 180}deg)`;
            document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
            document.getElementById('cloudCover').textContent = `${current.cloud_cover}%`;

            updateWeatherParticles(current.weather_code, current.wind_direction_10m);
        }

        // Update hourly temperatures display
        function updateHourlyTemps() {
            if (!weatherData) return;

            const container = document.getElementById('hourlyTemps');
            container.innerHTML = '';

            const hours = [0, 6, 12, 18];
            hours.forEach(hour => {
                const temp = Math.round(weatherData.hourly.temperature_2m[hour]);
                const weatherCode = weatherData.hourly.weather_code[hour];
                
                const hourlyDiv = document.createElement('div');
                hourlyDiv.className = 'hourly-temp';
                hourlyDiv.innerHTML = `
                    <div class="temp">${temp}¬∞</div>
                    <div>${weatherIcons[weatherCode] || '‚ùì'}</div>
                    <div class="time">${hour.toString().padStart(2, '0')}:00</div>
                `;
                container.appendChild(hourlyDiv);
            });
        }

        // Setup time slider
        function setupTimeSlider() {
            const slider = document.getElementById('timeSlider');
            const timeDisplay = document.getElementById('selectedTime');
            const liveIndicator = document.getElementById('liveIndicator');
            
            const now = new Date();
            const currentHour = now.getHours();
            slider.value = currentHour;
            selectedHour = currentHour;

            slider.addEventListener('input', (e) => {
                selectedHour = parseInt(e.target.value);
                isLiveMode = false;
                
                timeDisplay.textContent = `${selectedHour.toString().padStart(2, '0')}:00`;
                liveIndicator.style.display = 'none';
                
                updateWeatherDisplay();
            });

            slider.addEventListener('mouseup', () => {
                setTimeout(() => {
                    isLiveMode = true;
                    selectedHour = currentHour;
                    slider.value = currentHour;
                    timeDisplay.textContent = 'Nu';
                    liveIndicator.style.display = 'inline';
                    updateWeatherDisplay();
                }, 3000);
            });

            slider.addEventListener('touchend', () => {
                setTimeout(() => {
                    isLiveMode = true;
                    selectedHour = currentHour;
                    slider.value = currentHour;
                    timeDisplay.textContent = 'Nu';
                    liveIndicator.style.display = 'inline';
                    updateWeatherDisplay();
                }, 3000);
            });
        }

        // Get time period for sky colors
        function getTimePeriod(hour, sunrise, sunset) {
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;
            
            if (hour < sunriseHour - 1) return 'night';
            if (hour < sunriseHour + 1) return 'dawn';
            if (hour < 11) return 'morning';
            if (hour < sunsetHour - 1) return 'day';
            if (hour < sunsetHour + 1) return 'sunset';
            if (hour < 21) return 'dusk';
            return 'night';
        }

        // Interpolate between colors
        function interpolateColor(color1, color2, factor) {
            return [
                Math.round(color1[0] + (color2[0] - color1[0]) * factor),
                Math.round(color1[1] + (color2[1] - color1[1]) * factor),
                Math.round(color1[2] + (color2[2] - color1[2]) * factor)
            ];
        }

        // Create sky gradient
        function createSkyGradient(hour) {
            if (!weatherData) return;

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const period = getTimePeriod(hour, sunrise, sunset);
            
            const gradient = skyCtx.createLinearGradient(0, 0, 0, skyCanvas.height / (window.devicePixelRatio || 1));
            const colors = skyColors[period];
            
            colors.forEach(colorStop => {
                const [r, g, b] = colorStop.color;
                gradient.addColorStop(colorStop.pos, `rgb(${r}, ${g}, ${b})`);
            });
            
            return gradient;
        }

        // Create stars
        function createStars() {
            stars = [];
            const starCount = 200;
            
            for (let i = 0; i < starCount; i++) {
                stars.push({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight * 0.7,
                    size: Math.random() * 2 + 0.5,
                    brightness: Math.random(),
                    twinkleSpeed: Math.random() * 0.02 + 0.005,
                    twinkleOffset: Math.random() * Math.PI * 2
                });
            }
        }

        // Create clouds
        function createClouds() {
            clouds = [];
            const cloudCount = 12;
            
            for (let i = 0; i < cloudCount; i++) {
                const cloud = {
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight * 0.6 + 50,
                    speed: Math.random() * 0.3 + 0.1,
                    opacity: Math.random() * 0.7 + 0.3,
                    layers: []
                };
                
                // Create multiple layers for realistic cloud shape
                const layerCount = Math.floor(Math.random() * 4) + 3;
                for (let j = 0; j < layerCount; j++) {
                    cloud.layers.push({
                        x: Math.random() * 100 - 50,
                        y: Math.random() * 30 - 15,
                        radius: Math.random() * 40 + 20,
                        opacity: Math.random() * 0.8 + 0.2
                    });
                }
                
                clouds.push(cloud);
            }
        }

        // Draw stars
        function drawStars(hour) {
            if (!weatherData) return;

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;
            
            let starOpacity = 0;
            if (hour < sunriseHour - 0.5 || hour > sunsetHour + 0.5) {
                starOpacity = 1;
            } else if (hour < sunriseHour + 0.5) {
                starOpacity = Math.max(0, (sunriseHour - 0.5 - hour) / 1);
            } else if (hour > sunsetHour - 0.5) {
                starOpacity = Math.max(0, (hour - sunsetHour + 0.5) / 1);
            }

            if (starOpacity > 0) {
                stars.forEach(star => {
                    const time = Date.now() * star.twinkleSpeed + star.twinkleOffset;
                    const twinkle = (Math.sin(time) + 1) * 0.5;
                    const brightness = star.brightness * twinkle * starOpacity;
                    
                    skyCtx.beginPath();
                    skyCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    skyCtx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
                    skyCtx.shadowBlur = star.size * 2;
                    skyCtx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                    skyCtx.fill();
                    skyCtx.shadowBlur = 0;
                });
            }
        }

        // Draw sun
        function drawSun(hour) {
            if (!weatherData) return;

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;

            if (hour >= sunriseHour - 0.5 && hour <= sunsetHour + 0.5) {
                const sunProgress = Math.max(0, Math.min(1, (hour - sunriseHour) / (sunsetHour - sunriseHour)));
                const x = sunProgress * window.innerWidth;
                const y = Math.sin(sunProgress * Math.PI) * -200 + window.innerHeight * 0.4;
                
                // Sun glow
                const gradient = skyCtx.createRadialGradient(x, y, 0, x, y, 80);
                gradient.addColorStop(0, 'rgba(255, 247, 0, 0.8)');
                gradient.addColorStop(0.3, 'rgba(255, 200, 0, 0.6)');
                gradient.addColorStop(0.6, 'rgba(255, 152, 0, 0.3)');
                gradient.addColorStop(1, 'rgba(255, 152, 0, 0)');
                
                skyCtx.fillStyle = gradient;
                skyCtx.beginPath();
                skyCtx.arc(x, y, 80, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Sun disc
                skyCtx.fillStyle = '#FFF700';
                skyCtx.beginPath();
                skyCtx.arc(x, y, 25, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Sun rays
                const rayCount = 12;
                skyCtx.strokeStyle = 'rgba(255, 247, 0, 0.6)';
                skyCtx.lineWidth = 2;
                for (let i = 0; i < rayCount; i++) {
                    const angle = (i / rayCount) * Math.PI * 2 + Date.now() * 0.0005;
                    const rayLength = 15;
                    skyCtx.beginPath();
                    skyCtx.moveTo(x + Math.cos(angle) * 35, y + Math.sin(angle) * 35);
                    skyCtx.lineTo(x + Math.cos(angle) * (35 + rayLength), y + Math.sin(angle) * (35 + rayLength));
                    skyCtx.stroke();
                }
            }
        }

        // Draw moon
        function drawMoon(hour) {
            if (!weatherData) return;

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;

            if (hour < sunriseHour || hour > sunsetHour) {
                let moonProgress;
                if (hour > sunsetHour) {
                    moonProgress = (hour - sunsetHour) / (24 - sunsetHour + sunriseHour);
                } else {
                    moonProgress = (hour + 24 - sunsetHour) / (24 - sunsetHour + sunriseHour);
                }
                
                const x = moonProgress * window.innerWidth;
                const y = Math.sin(moonProgress * Math.PI) * -150 + window.innerHeight * 0.3;
                
                // Moon glow
                const gradient = skyCtx.createRadialGradient(x, y, 0, x, y, 40);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
                gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                skyCtx.fillStyle = gradient;
                skyCtx.beginPath();
                skyCtx.arc(x, y, 40, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Moon disc
                skyCtx.fillStyle = '#F5F5DC';
                skyCtx.beginPath();
                skyCtx.arc(x, y, 18, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Moon craters
                skyCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                skyCtx.beginPath();
                skyCtx.arc(x - 4, y - 2, 2, 0, Math.PI * 2);
                skyCtx.arc(x + 3, y + 4, 1.5, 0, Math.PI * 2);
                skyCtx.arc(x - 2, y + 6, 1, 0, Math.PI * 2);
                skyCtx.fill();
            }
        }

        // Draw clouds
        function drawClouds(hour) {
            if (!weatherData) return;

            const period = getTimePeriod(hour, new Date(weatherData.daily.sunrise[0]), new Date(weatherData.daily.sunset[0]));
            const cloudCover = isLiveMode ? weatherData.current.cloud_cover : weatherData.hourly.cloud_cover[selectedHour];
            
            // Cloud color based on time of day
            let cloudColor = [255, 255, 255]; // Default white
            if (period === 'dawn' || period === 'sunset') {
                cloudColor = [255, 180, 120]; // Orange tint
            } else if (period === 'dusk') {
                cloudColor = [200, 150, 200]; // Purple tint
            } else if (period === 'night') {
                cloudColor = [100, 100, 120]; // Dark gray
            }

            const visibleClouds = Math.ceil((cloudCover / 100) * clouds.length);
            
            for (let i = 0; i < visibleClouds; i++) {
                const cloud = clouds[i];
                
                cloud.layers.forEach(layer => {
                    const x = cloud.x + layer.x;
                    const y = cloud.y + layer.y;
                    const opacity = (cloudCover / 100) * cloud.opacity * layer.opacity * 0.8;
                    
                    // Create soft cloud with multiple circles
                    const gradient = skyCtx.createRadialGradient(x, y, 0, x, y, layer.radius);
                    gradient.addColorStop(0, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, ${opacity})`);
                    gradient.addColorStop(0.7, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, ${opacity * 0.5})`);
                    gradient.addColorStop(1, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, 0)`);
                    
                    skyCtx.fillStyle = gradient;
                    skyCtx.beginPath();
                    skyCtx.arc(x, y, layer.radius, 0, Math.PI * 2);
                    skyCtx.fill();
                });
                
                // Move cloud
                cloud.x += cloud.speed;
                if (cloud.x > window.innerWidth + 100) {
                    cloud.x = -100;
                    cloud.y = Math.random() * window.innerHeight * 0.6 + 50;
                }
            }
        }

        // Update weather particles
        function updateWeatherParticles(weatherCode, windDirection) {
            particles = [];
            
            if (weatherCode >= 61 && weatherCode <= 67 || weatherCode >= 80 && weatherCode <= 82) {
                // Rain
                for (let i = 0; i < 100; i++) {
                    particles.push({
                        type: 'rain',
                        x: Math.random() * window.innerWidth,
                        y: Math.random() * -window.innerHeight,
                        speed: Math.random() * 5 + 5,
                        windOffset: Math.cos((windDirection || 0) * Math.PI / 180) * 2,
                        length: Math.random() * 15 + 10,
                        opacity: Math.random() * 0.7 + 0.3
                    });
                }
            } else if (weatherCode >= 71 && weatherCode <= 77 || weatherCode >= 85 && weatherCode <= 86) {
                // Snow
                for (let i = 0; i < 50; i++) {
                    particles.push({
                        type: 'snow',
                        x: Math.random() * window.innerWidth,
                        y: Math.random() * -window.innerHeight,
                        speed: Math.random() * 1 + 0.5,
                        windOffset: Math.cos((windDirection || 0) * Math.PI / 180) * 0.5,
                        size: Math.random() * 4 + 2,
                        opacity: Math.random() * 0.8 + 0.2,
                        rotation: Math.random() * Math.PI * 2,
                        rotationSpeed: (Math.random() - 0.5) * 0.02
                    });
                }
            }
        }

        // Draw weather particles
        function drawWeatherParticles() {
            particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
            
            particles.forEach((particle, index) => {
                if (particle.type === 'rain') {
                    particlesCtx.strokeStyle = `rgba(135, 206, 250, ${particle.opacity})`;
                    particlesCtx.lineWidth = 1;
                    particlesCtx.beginPath();
                    particlesCtx.moveTo(particle.x, particle.y);
                    particlesCtx.lineTo(particle.x + particle.windOffset, particle.y + particle.length);
                    particlesCtx.stroke();
                    
                    particle.y += particle.speed;
                    particle.x += particle.windOffset * 0.5;
                } else if (particle.type === 'snow') {
                    particlesCtx.fillStyle = `rgba(255, 255, 255, ${particle.opacity})`;
                    particlesCtx.beginPath();
                    particlesCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    particlesCtx.fill();
                    
                    particle.y += particle.speed;
                    particle.x += particle.windOffset + Math.sin(particle.y * 0.01) * 0.5;
                    particle.rotation += particle.rotationSpeed;
                }
                
                // Remove particles that have fallen off screen
                if (particle.y > window.innerHeight + 50) {
                    particles[index] = {
                        ...particle,
                        y: -50,
                        x: Math.random() * window.innerWidth
                    };
                }
            });
        }

        // Main animation loop
        function startAnimationLoop() {
            function animate() {
                if (weatherData) {
                    const hour = isLiveMode ? new Date().getHours() + new Date().getMinutes() / 60 : selectedHour;
                    
                    // Clear canvas
                    skyCtx.clearRect(0, 0, skyCanvas.width, skyCanvas.height);
                    
                    // Draw sky gradient
                    skyCtx.fillStyle = createSkyGradient(hour);
                    skyCtx.fillRect(0, 0, skyCanvas.width / (window.devicePixelRatio || 1), skyCanvas.height / (window.devicePixelRatio || 1));
                    
                    // Draw celestial objects and effects
                    drawStars(hour);
                    drawMoon(hour);
                    drawSun(hour);
                    drawClouds(hour);
                    
                    // Draw weather particles
                    drawWeatherParticles();
                }
                
                animationFrame = requestAnimationFrame(animate);
            }
            animate();
        }

        // Initialize the app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>