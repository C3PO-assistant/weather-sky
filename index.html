<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weer in Zeist - Spectaculaire Lucht</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        .sky-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0c1445;
            transition: background 2s ease;
        }

        .sky-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .weather-info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .current-weather {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .temp-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .temperature {
            font-size: 48px;
            font-weight: 200;
        }

        .weather-icon {
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .details-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .location {
            font-size: 18px;
            font-weight: 300;
            opacity: 0.9;
        }

        .description {
            font-size: 16px;
            opacity: 0.8;
            text-transform: capitalize;
        }

        .weather-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            opacity: 0.9;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .wind-arrow {
            transform-origin: center;
            transition: transform 0.5s ease;
        }

        .time-scrubber {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            padding: 20px;
            z-index: 100;
        }

        .time-display {
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: 300;
            margin-bottom: 15px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .live-indicator {
            color: #4CAF50;
            font-weight: 500;
        }

        .slider-container {
            position: relative;
            margin-bottom: 15px;
        }

        .time-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .time-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .time-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .hour-markers {
            display: flex;
            justify-content: space-between;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-top: 8px;
            margin-bottom: 15px;
        }

        /* Temperatuur sparkline grafiek */
        .temp-sparkline {
            height: 40px;
            margin: 10px 0;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 8px;
        }

        .sparkline-canvas {
            width: 100%;
            height: 100%;
        }

        /* Weer-iconen per 3 uur */
        .weather-timeline {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .weather-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            font-size: 11px;
            min-width: 35px;
        }

        .weather-point .icon {
            font-size: 16px;
            margin-bottom: 2px;
        }

        .weather-point .temp {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .weather-point .time {
            opacity: 0.7;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .particles-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        @media (max-width: 768px) {
            .weather-info {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            .current-weather {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .temperature {
                font-size: 36px;
            }
            
            .weather-details {
                gap: 10px;
            }
            
            .time-scrubber {
                padding: 15px;
            }
            
            .weather-timeline {
                gap: 5px;
            }

            .weather-point {
                min-width: 28px;
                font-size: 10px;
            }

            .weather-point .icon {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="sky-container" id="skyContainer">
        <canvas class="sky-canvas" id="skyCanvas"></canvas>
        <canvas class="particles-canvas" id="particlesCanvas"></canvas>
    </div>

    <div class="loading" id="loading">Weerdata laden...</div>

    <div class="weather-info" id="weatherInfo" style="display: none;">
        <div class="current-weather">
            <div class="temp-section">
                <div class="temperature" id="temperature">-¬∞</div>
                <div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
            </div>
            <div class="details-section">
                <div class="location">Zeist, Nederland</div>
                <div class="description" id="description">-</div>
            </div>
        </div>
        <div class="weather-details">
            <div class="detail-item">
                <span>üå°Ô∏è</span>
                <span id="feelsLike">Voelt als -¬∞</span>
            </div>
            <div class="detail-item">
                <span class="wind-arrow" id="windArrow">‚Üë</span>
                <span id="wind">- km/h</span>
            </div>
            <div class="detail-item">
                <span>üíß</span>
                <span id="humidity">-%</span>
            </div>
            <div class="detail-item">
                <span>‚òÅÔ∏è</span>
                <span id="cloudCover">-%</span>
            </div>
        </div>
    </div>

    <div class="time-scrubber" id="timeScrubber" style="display: none;">
        <div class="time-display" id="timeDisplay">
            <span class="live-indicator" id="liveIndicator">üî¥ LIVE</span> 
            <span id="selectedTime">Nu</span>
        </div>
        
        <div class="slider-container">
            <input type="range" min="0" max="23" step="1" value="0" class="time-slider" id="timeSlider">
            <div class="hour-markers" id="hourMarkers">
                <span>Nu</span><span>+6u</span><span>+12u</span><span>+18u</span><span>+24u</span>
            </div>
        </div>
        
        <!-- Temperatuur sparkline -->
        <div class="temp-sparkline">
            <canvas class="sparkline-canvas" id="sparklineCanvas"></canvas>
        </div>

        <!-- Weer-iconen per 3 uur -->
        <div class="weather-timeline" id="weatherTimeline"></div>
    </div>

    <script>
        // Weather descriptions and icons
        const weatherDescriptions = {
            0: 'Helder', 1: 'Overwegend helder', 2: 'Gedeeltelijk bewolkt', 3: 'Bewolkt',
            45: 'Mist', 48: 'Ijsmist', 51: 'Lichte motregen', 53: 'Matige motregen', 55: 'Dichte motregen',
            56: 'Lichte ijzel', 57: 'Dichte ijzel', 61: 'Lichte regen', 63: 'Matige regen', 65: 'Zware regen',
            66: 'Lichte ijsregen', 67: 'Zware ijsregen', 71: 'Lichte sneeuw', 73: 'Matige sneeuw', 75: 'Zware sneeuw',
            77: 'Sneeuwkorrels', 80: 'Lichte buien', 81: 'Matige buien', 82: 'Zware buien',
            85: 'Lichte sneeuwbuien', 86: 'Zware sneeuwbuien', 95: 'Onweer', 96: 'Onweer met hagel', 99: 'Zwaar onweer met hagel'
        };

        const weatherIcons = {
            0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
            51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üå¶Ô∏è', 56: 'üå®Ô∏è', 57: 'üå®Ô∏è',
            61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è', 66: 'üåßÔ∏è', 67: 'üåßÔ∏è',
            71: '‚ùÑÔ∏è', 73: '‚ùÑÔ∏è', 75: '‚ùÑÔ∏è', 77: '‚ùÑÔ∏è', 80: 'üå¶Ô∏è', 81: 'üå¶Ô∏è', 82: 'üå¶Ô∏è',
            85: 'üå®Ô∏è', 86: 'üå®Ô∏è', 95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
        };

        // Nederlandse dagen
        const dagen = ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'];

        // Global variables
        let weatherData = null;
        let skyCanvas, skyCtx, particlesCanvas, particlesCtx, sparklineCanvas, sparklineCtx;
        let animationFrame = null;
        let isLiveMode = true;
        let selectedHourOffset = 0; // Uren vanaf nu (0-23)
        let baseTime = null; // Referentie tijd voor de tijdlijn
        let clouds = [];
        let stars = [];
        let particles = [];
        let inactivityTimer = null;

        // Realistic sky color palettes based on real photos
        const skyColors = {
            night: [
                { pos: 0, color: [10, 14, 39] },       // #0a0e27 - Deep navy top
                { pos: 0.3, color: [20, 24, 50] },     // #141832 - Navy blue
                { pos: 0.7, color: [26, 31, 58] },     // #1a1f3a - Lighter navy
                { pos: 1, color: [26, 31, 58] }        // #1a1f3a - Bottom
            ],
            earlyDawn: [
                { pos: 0, color: [15, 21, 53] },       // #0f1535 - Dark blue-purple top
                { pos: 0.2, color: [45, 27, 78] },     // #2d1b4e - Deep purple
                { pos: 0.5, color: [107, 58, 94] },    // #6b3a5e - Purple-pink
                { pos: 0.8, color: [196, 106, 78] },   // #c46a4e - Orange-red
                { pos: 1, color: [232, 168, 88] }      // #e8a858 - Golden horizon
            ],
            dawn: [
                { pos: 0, color: [26, 42, 92] },       // #1a2a5c - Deep blue top
                { pos: 0.2, color: [74, 63, 124] },    // #4a3f7c - Blue-purple
                { pos: 0.5, color: [194, 118, 118] },  // #c27676 - Pink
                { pos: 0.8, color: [232, 151, 106] },  // #e8976a - Orange
                { pos: 1, color: [245, 200, 66] }      // #f5c842 - Yellow horizon
            ],
            morning: [
                { pos: 0, color: [44, 95, 138] },      // #2c5f8a - Deep sky blue top
                { pos: 0.3, color: [90, 139, 181] },   // #5a8bb5 - Sky blue
                { pos: 0.7, color: [135, 181, 212] },  // #87b5d4 - Light sky blue
                { pos: 1, color: [181, 212, 232] }     // #b5d4e8 - Pale blue horizon
            ],
            day: [
                { pos: 0, color: [30, 87, 153] },      // #1e5799 - Deep sky blue top
                { pos: 0.4, color: [58, 124, 196] },   // #3a7cc4 - Sky blue
                { pos: 0.8, color: [106, 173, 222] },  // #6aadde - Light sky blue
                { pos: 1, color: [158, 204, 232] }     // #9ecce8 - Very light blue horizon
            ],
            lateAfternoon: [
                { pos: 0, color: [30, 87, 153] },      // #1e5799 - Deep sky blue top
                { pos: 0.3, color: [74, 124, 170] },   // #4a7caa - Blue
                { pos: 0.7, color: [138, 171, 204] },  // #8aabcc - Light blue
                { pos: 1, color: [196, 200, 181] }     // #c4c8b5 - Warm pale blue horizon
            ],
            sunset: [
                { pos: 0, color: [26, 42, 92] },       // #1a2a5c - Deep blue top
                { pos: 0.2, color: [74, 42, 106] },    // #4a2a6a - Purple
                { pos: 0.4, color: [138, 58, 90] },    // #8a3a5a - Pink-purple
                { pos: 0.7, color: [204, 85, 68] },    // #cc5544 - Red-orange
                { pos: 0.9, color: [232, 138, 51] },   // #e88a33 - Orange
                { pos: 1, color: [245, 184, 66] }      // #f5b842 - Yellow horizon
            ],
            dusk: [
                { pos: 0, color: [15, 21, 53] },       // #0f1535 - Dark blue top
                { pos: 0.3, color: [42, 24, 72] },     // #2a1848 - Purple
                { pos: 0.5, color: [74, 32, 80] },     // #4a2050 - Pink-purple
                { pos: 0.8, color: [122, 58, 74] },    // #7a3a4a - Red-purple
                { pos: 1, color: [184, 90, 64] }       // #b85a40 - Orange horizon
            ],
            evening: [
                { pos: 0, color: [10, 14, 39] },       // #0a0e27 - Deep navy top
                { pos: 0.3, color: [21, 26, 56] },     // #151a38 - Navy
                { pos: 0.7, color: [31, 32, 64] },     // #1f2040 - Blue-gray
                { pos: 1, color: [42, 37, 69] }        // #2a2545 - Purple-gray horizon
            ]
        };

        // Initialize the app
        async function init() {
            baseTime = new Date();
            setupCanvas();
            await fetchWeatherData();
            setupTimeSlider();
            createStars();
            createClouds();
            startAnimationLoop();
            
            // Auto-refresh every 10 minutes
            setInterval(fetchWeatherData, 10 * 60 * 1000);
            
            // Update live time every minute
            setInterval(() => {
                if (isLiveMode) {
                    baseTime = new Date();
                    updateTimeDisplay();
                    updateWeatherDisplay();
                }
            }, 60000);
        }

        // Setup canvas
        function setupCanvas() {
            skyCanvas = document.getElementById('skyCanvas');
            skyCtx = skyCanvas.getContext('2d');
            particlesCanvas = document.getElementById('particlesCanvas');
            particlesCtx = particlesCanvas.getContext('2d');
            sparklineCanvas = document.getElementById('sparklineCanvas');
            sparklineCtx = sparklineCanvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            [skyCanvas, particlesCanvas].forEach(canvas => {
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                canvas.getContext('2d').scale(dpr, dpr);
            });

            // Sparkline canvas
            const sparklineContainer = sparklineCanvas.parentElement;
            const sparklineWidth = sparklineContainer.clientWidth - 16; // padding
            const sparklineHeight = sparklineContainer.clientHeight - 16;
            sparklineCanvas.width = sparklineWidth * dpr;
            sparklineCanvas.height = sparklineHeight * dpr;
            sparklineCanvas.style.width = sparklineWidth + 'px';
            sparklineCanvas.style.height = sparklineHeight + 'px';
            sparklineCtx.scale(dpr, dpr);

            if (weatherData) {
                drawSparkline();
            }
        }

        // Fetch weather data
        async function fetchWeatherData() {
            try {
                const response = await fetch(
                    'https://api.open-meteo.com/v1/forecast?latitude=52.09&longitude=5.23&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,precipitation&hourly=temperature_2m,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m,precipitation&daily=sunrise,sunset&timezone=Europe/Amsterdam&forecast_days=2'
                );
                
                weatherData = await response.json();
                updateWeatherDisplay();
                updateWeatherTimeline();
                drawSparkline();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('weatherInfo').style.display = 'block';
                document.getElementById('timeScrubber').style.display = 'block';
            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById('loading').textContent = 'Fout bij laden weerdata';
            }
        }

        // Update time display
        function updateTimeDisplay() {
            const selectedTime = document.getElementById('selectedTime');
            if (isLiveMode) {
                selectedTime.textContent = 'Nu';
            } else {
                const targetTime = new Date(baseTime.getTime() + selectedHourOffset * 60 * 60 * 1000);
                const day = dagen[targetTime.getDay()];
                const hour = targetTime.getHours().toString().padStart(2, '0');
                const minute = targetTime.getMinutes().toString().padStart(2, '0');
                selectedTime.textContent = `${day} ${hour}:${minute}`;
            }
        }

        // Get weather data for specific hour offset
        function getWeatherForHourOffset(offset) {
            if (!weatherData || !weatherData.hourly) return null;

            const maxOffset = Math.min(offset, weatherData.hourly.temperature_2m.length - 1);
            
            return {
                temperature_2m: weatherData.hourly.temperature_2m[maxOffset],
                apparent_temperature: weatherData.hourly.temperature_2m[maxOffset] - 2,
                weather_code: weatherData.hourly.weather_code[maxOffset],
                cloud_cover: weatherData.hourly.cloud_cover[maxOffset],
                wind_speed_10m: weatherData.hourly.wind_speed_10m[maxOffset],
                wind_direction_10m: weatherData.hourly.wind_direction_10m[maxOffset],
                relative_humidity_2m: weatherData.current.relative_humidity_2m,
                precipitation: weatherData.hourly.precipitation[maxOffset]
            };
        }

        // Update weather display
        function updateWeatherDisplay() {
            if (!weatherData) return;

            let current;
            if (isLiveMode) {
                current = weatherData.current;
            } else {
                current = getWeatherForHourOffset(selectedHourOffset);
                if (!current) return;
            }

            document.getElementById('temperature').textContent = `${Math.round(current.temperature_2m)}¬∞`;
            document.getElementById('feelsLike').textContent = `Voelt als ${Math.round(current.apparent_temperature)}¬∞`;
            document.getElementById('description').textContent = weatherDescriptions[current.weather_code] || 'Onbekend';
            document.getElementById('weatherIcon').textContent = weatherIcons[current.weather_code] || '‚ùì';
            
            document.getElementById('wind').textContent = `${Math.round(current.wind_speed_10m)} km/h`;
            document.getElementById('windArrow').style.transform = `rotate(${current.wind_direction_10m + 180}deg)`;
            document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
            document.getElementById('cloudCover').textContent = `${current.cloud_cover}%`;

            // Update particles when weather display changes
            updateWeatherParticles(current.weather_code, current.wind_direction_10m);
        }

        // Draw temperature sparkline with improved styling
        function drawSparkline() {
            if (!weatherData || !sparklineCtx) return;

            const canvas = sparklineCanvas;
            const ctx = sparklineCtx;
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Get 24 hour temperature data
            const temps = [];
            for (let i = 0; i < 24; i++) {
                if (i < weatherData.hourly.temperature_2m.length) {
                    temps.push(weatherData.hourly.temperature_2m[i]);
                }
            }

            if (temps.length < 2) return;

            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            const tempRange = maxTemp - minTemp || 1; // Avoid division by zero

            // Draw temperature line with thicker stroke
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.lineWidth = 4; // Increased from 2 to 4
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();

            temps.forEach((temp, i) => {
                const x = (i / (temps.length - 1)) * width;
                const y = height - ((temp - minTemp) / tempRange) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Draw min/max points with larger labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';
            ctx.font = '14px -apple-system'; // Increased from 10px to 14px
            ctx.textAlign = 'center';

            const minIndex = temps.indexOf(minTemp);
            const maxIndex = temps.indexOf(maxTemp);

            // Min point
            const minX = (minIndex / (temps.length - 1)) * width;
            const minY = height - ((minTemp - minTemp) / tempRange) * height;
            ctx.fillRect(minX - 3, minY - 3, 6, 6); // Larger point
            ctx.fillText(`${Math.round(minTemp)}¬∞`, minX, minY - 12);

            // Max point  
            const maxX = (maxIndex / (temps.length - 1)) * width;
            const maxY = height - ((maxTemp - minTemp) / tempRange) * height;
            ctx.fillRect(maxX - 3, maxY - 3, 6, 6); // Larger point
            ctx.fillText(`${Math.round(maxTemp)}¬∞`, maxX, maxY - 12);
        }

        // Update weather timeline with snow icons
        function updateWeatherTimeline() {
            if (!weatherData) return;

            const container = document.getElementById('weatherTimeline');
            container.innerHTML = '';

            // Show weather for every 3 hours over 24 hours
            for (let i = 0; i < 24; i += 3) {
                if (i >= weatherData.hourly.temperature_2m.length) break;

                const targetTime = new Date(baseTime.getTime() + i * 60 * 60 * 1000);
                const day = dagen[targetTime.getDay()];
                const hour = targetTime.getHours().toString().padStart(2, '0');
                const temp = Math.round(weatherData.hourly.temperature_2m[i]);
                const weatherCode = weatherData.hourly.weather_code[i];
                
                const pointDiv = document.createElement('div');
                pointDiv.className = 'weather-point';
                
                let timeLabel;
                if (i === 0) {
                    timeLabel = 'Nu';
                } else {
                    timeLabel = `${day} ${hour}:00`;
                }

                // Make sure snow codes (71-77) show snow emoji ‚ùÑÔ∏è
                let icon = weatherIcons[weatherCode];
                if (weatherCode >= 71 && weatherCode <= 77) {
                    icon = '‚ùÑÔ∏è';
                }
                
                pointDiv.innerHTML = `
                    <div class="icon">${icon || '‚ùì'}</div>
                    <div class="temp">${temp}¬∞</div>
                    <div class="time">${timeLabel}</div>
                `;
                container.appendChild(pointDiv);
            }
        }

        // Setup time slider
        function setupTimeSlider() {
            const slider = document.getElementById('timeSlider');
            const timeDisplay = document.getElementById('selectedTime');
            const liveIndicator = document.getElementById('liveIndicator');
            
            slider.value = 0;
            selectedHourOffset = 0;

            // Clear any existing timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }

            slider.addEventListener('input', (e) => {
                selectedHourOffset = parseInt(e.target.value);
                isLiveMode = false;
                
                updateTimeDisplay();
                liveIndicator.style.display = 'none';
                
                updateWeatherDisplay();

                // Clear existing timer
                if (inactivityTimer) {
                    clearTimeout(inactivityTimer);
                }

                // Set timer to return to live mode after 3 seconds
                inactivityTimer = setTimeout(() => {
                    isLiveMode = true;
                    selectedHourOffset = 0;
                    slider.value = 0;
                    updateTimeDisplay();
                    liveIndicator.style.display = 'inline';
                    updateWeatherDisplay();
                }, 3000);
            });

            // Update time display initially
            updateTimeDisplay();
        }

        // Get time period for sky colors with smooth transitions
        function getTimePeriod(hour) {
            if (!weatherData) return 'day';

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;
            
            if (hour >= 0 && hour < 5) return 'night';
            if (hour >= 5.5 && hour < 6.5) return 'earlyDawn';
            if (hour >= 6.5 && hour < 7.5) return 'dawn';
            if (hour >= 8 && hour < 10) return 'morning';
            if (hour >= 11 && hour < 15) return 'day';
            if (hour >= 15 && hour < 16.5) return 'lateAfternoon';
            if (hour >= 16.5 && hour < 18) return 'sunset';
            if (hour >= 18 && hour < 19.5) return 'dusk';
            if (hour >= 19.5 && hour < 21) return 'evening';
            return 'night';
        }

        // Interpolate between colors
        function interpolateColor(color1, color2, factor) {
            return [
                Math.round(color1[0] + (color2[0] - color1[0]) * factor),
                Math.round(color1[1] + (color2[1] - color1[1]) * factor),
                Math.round(color1[2] + (color2[2] - color1[2]) * factor)
            ];
        }

        // Create smooth sky gradient with realistic colors
        function createSkyGradient(hour) {
            if (!weatherData) return;

            // Determine current and next period for smooth transitions
            let currentPeriod = getTimePeriod(hour);
            let nextPeriod = getTimePeriod(hour + 0.5);
            let transitionFactor = 0;

            // Calculate transition factor based on hour
            const periodBoundaries = {
                night: [0, 5], earlyDawn: [5.5, 6.5], dawn: [6.5, 7.5], morning: [8, 10],
                day: [11, 15], lateAfternoon: [15, 16.5], sunset: [16.5, 18], 
                dusk: [18, 19.5], evening: [19.5, 21]
            };

            // If we're transitioning between periods
            if (currentPeriod !== nextPeriod) {
                const currentRange = periodBoundaries[currentPeriod];
                if (currentRange) {
                    const periodLength = currentRange[1] - currentRange[0];
                    const positionInPeriod = hour - currentRange[0];
                    transitionFactor = Math.min(1, Math.max(0, positionInPeriod / periodLength));
                }
            }

            const gradient = skyCtx.createLinearGradient(0, 0, 0, skyCanvas.height / (window.devicePixelRatio || 1));
            
            const currentColors = skyColors[currentPeriod] || skyColors.day;
            const nextColors = skyColors[nextPeriod] || skyColors.day;

            // Create gradient with interpolated colors if transitioning
            currentColors.forEach((colorStop, index) => {
                let finalColor = colorStop.color;
                
                if (transitionFactor > 0 && nextColors[index]) {
                    finalColor = interpolateColor(colorStop.color, nextColors[index].color, transitionFactor);
                }
                
                const [r, g, b] = finalColor;
                gradient.addColorStop(colorStop.pos, `rgb(${r}, ${g}, ${b})`);
            });
            
            return gradient;
        }

        // Create stars
        function createStars() {
            stars = [];
            const starCount = 200;
            
            for (let i = 0; i < starCount; i++) {
                stars.push({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight * 0.7,
                    size: Math.random() * 2 + 0.5,
                    brightness: Math.random(),
                    twinkleSpeed: Math.random() * 0.02 + 0.005,
                    twinkleOffset: Math.random() * Math.PI * 2
                });
            }
        }

        // Create realistic clouds with many overlapping circles
        function createClouds() {
            clouds = [];
            const cloudCount = 15; // More clouds for better coverage
            
            for (let i = 0; i < cloudCount; i++) {
                const cloud = {
                    x: Math.random() * (window.innerWidth + 200) - 100,
                    y: Math.random() * window.innerHeight * 0.6 + 50,
                    speed: Math.random() * 0.3 + 0.1,
                    opacity: Math.random() * 0.7 + 0.3,
                    circles: [] // Many overlapping circles for realistic shape
                };
                
                // Create 20-30 overlapping circles per cloud
                const circleCount = Math.floor(Math.random() * 11) + 20; // 20-30 circles
                const baseRadius = Math.random() * 30 + 40;
                
                for (let j = 0; j < circleCount; j++) {
                    // Cluster circles around the center with some spread
                    const angle = Math.random() * Math.PI * 2;
                    const distance = Math.random() * baseRadius * 0.8;
                    
                    cloud.circles.push({
                        x: Math.cos(angle) * distance,
                        y: Math.sin(angle) * distance * 0.6, // Flatten vertically
                        radius: Math.random() * baseRadius * 0.7 + baseRadius * 0.3,
                        opacity: Math.random() * 0.6 + 0.2
                    });
                }
                
                clouds.push(cloud);
            }
        }

        // Draw stars
        function drawStars(hour) {
            if (!weatherData) return;

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;
            
            let starOpacity = 0;
            if (hour < sunriseHour - 0.5 || hour > sunsetHour + 0.5) {
                starOpacity = 1;
            } else if (hour < sunriseHour + 0.5) {
                starOpacity = Math.max(0, (sunriseHour - 0.5 - hour) / 1);
            } else if (hour > sunsetHour - 0.5) {
                starOpacity = Math.max(0, (hour - sunsetHour + 0.5) / 1);
            }

            if (starOpacity > 0) {
                stars.forEach(star => {
                    const time = Date.now() * star.twinkleSpeed + star.twinkleOffset;
                    const twinkle = (Math.sin(time) + 1) * 0.5;
                    const brightness = star.brightness * twinkle * starOpacity;
                    
                    skyCtx.beginPath();
                    skyCtx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    skyCtx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
                    skyCtx.shadowBlur = star.size * 2;
                    skyCtx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                    skyCtx.fill();
                    skyCtx.shadowBlur = 0;
                });
            }
        }

        // Draw sun (hidden when cloud cover > 90%)
        function drawSun(hour, cloudCover) {
            if (!weatherData || cloudCover > 90) return; // Hide sun when fully cloudy

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;

            if (hour >= sunriseHour - 0.5 && hour <= sunsetHour + 0.5) {
                const sunProgress = Math.max(0, Math.min(1, (hour - sunriseHour) / (sunsetHour - sunriseHour)));
                const x = sunProgress * window.innerWidth;
                const y = Math.sin(sunProgress * Math.PI) * -200 + window.innerHeight * 0.4;
                
                // Reduce sun intensity based on cloud cover
                const intensity = Math.max(0.2, 1 - (cloudCover / 100));
                
                // Sun glow
                const gradient = skyCtx.createRadialGradient(x, y, 0, x, y, 80);
                gradient.addColorStop(0, `rgba(255, 247, 0, ${0.8 * intensity})`);
                gradient.addColorStop(0.3, `rgba(255, 200, 0, ${0.6 * intensity})`);
                gradient.addColorStop(0.6, `rgba(255, 152, 0, ${0.3 * intensity})`);
                gradient.addColorStop(1, 'rgba(255, 152, 0, 0)');
                
                skyCtx.fillStyle = gradient;
                skyCtx.beginPath();
                skyCtx.arc(x, y, 80, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Sun disc
                skyCtx.fillStyle = `rgba(255, 247, 0, ${intensity})`;
                skyCtx.beginPath();
                skyCtx.arc(x, y, 25, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Sun rays
                const rayCount = 12;
                skyCtx.strokeStyle = `rgba(255, 247, 0, ${0.6 * intensity})`;
                skyCtx.lineWidth = 2;
                for (let i = 0; i < rayCount; i++) {
                    const angle = (i / rayCount) * Math.PI * 2 + Date.now() * 0.0005;
                    const rayLength = 15;
                    skyCtx.beginPath();
                    skyCtx.moveTo(x + Math.cos(angle) * 35, y + Math.sin(angle) * 35);
                    skyCtx.lineTo(x + Math.cos(angle) * (35 + rayLength), y + Math.sin(angle) * (35 + rayLength));
                    skyCtx.stroke();
                }
            }
        }

        // Draw moon
        function drawMoon(hour) {
            if (!weatherData) return;

            const sunrise = new Date(weatherData.daily.sunrise[0]);
            const sunset = new Date(weatherData.daily.sunset[0]);
            const sunriseHour = sunrise.getHours() + sunrise.getMinutes() / 60;
            const sunsetHour = sunset.getHours() + sunset.getMinutes() / 60;

            if (hour < sunriseHour || hour > sunsetHour) {
                let moonProgress;
                if (hour > sunsetHour) {
                    moonProgress = (hour - sunsetHour) / (24 - sunsetHour + sunriseHour);
                } else {
                    moonProgress = (hour + 24 - sunsetHour) / (24 - sunsetHour + sunriseHour);
                }
                
                const x = moonProgress * window.innerWidth;
                const y = Math.sin(moonProgress * Math.PI) * -150 + window.innerHeight * 0.3;
                
                // Moon glow
                const gradient = skyCtx.createRadialGradient(x, y, 0, x, y, 40);
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
                gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
                gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
                
                skyCtx.fillStyle = gradient;
                skyCtx.beginPath();
                skyCtx.arc(x, y, 40, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Moon disc
                skyCtx.fillStyle = '#F5F5DC';
                skyCtx.beginPath();
                skyCtx.arc(x, y, 18, 0, Math.PI * 2);
                skyCtx.fill();
                
                // Moon craters
                skyCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                skyCtx.beginPath();
                skyCtx.arc(x - 4, y - 2, 2, 0, Math.PI * 2);
                skyCtx.arc(x + 3, y + 4, 1.5, 0, Math.PI * 2);
                skyCtx.arc(x - 2, y + 6, 1, 0, Math.PI * 2);
                skyCtx.fill();
            }
        }

        // Draw realistic clouds with many overlapping circles
        function drawClouds(hour, cloudCover) {
            if (!weatherData) return;

            const period = getTimePeriod(hour);
            
            // Realistic cloud colors based on time of day
            let cloudColor = [255, 255, 255]; // Default white
            let shadowColor = [200, 200, 200]; // Light gray shadow
            
            if (period === 'earlyDawn' || period === 'dawn') {
                cloudColor = [255, 220, 180]; // Warm dawn colors
                shadowColor = [180, 150, 120];
            } else if (period === 'sunset') {
                cloudColor = [255, 200, 150]; // Subtle warm sunset tones
                shadowColor = [200, 140, 100];
            } else if (period === 'dusk') {
                cloudColor = [180, 160, 180]; // Purple-gray dusk
                shadowColor = [120, 100, 120];
            } else if (period === 'night' || period === 'evening') {
                cloudColor = [80, 80, 100]; // Dark gray for night
                shadowColor = [50, 50, 60];
            }

            // Determine how many clouds to show based on cloud coverage
            const totalClouds = clouds.length;
            const visibleCloudRatio = Math.min(1, cloudCover / 100);
            const visibleClouds = Math.ceil(visibleCloudRatio * totalClouds);
            
            // For 100% cloud cover, show all clouds and make them larger/more opaque
            const coverageMultiplier = cloudCover > 80 ? 1.5 : 1;

            skyCtx.globalCompositeOperation = 'source-over';

            for (let i = 0; i < visibleClouds; i++) {
                const cloud = clouds[i];
                const baseOpacity = (cloudCover / 100) * cloud.opacity * 0.8;
                
                // Draw each circle in the cloud
                cloud.circles.forEach((circle, circleIndex) => {
                    const x = cloud.x + circle.x;
                    const y = cloud.y + circle.y;
                    const radius = circle.radius * coverageMultiplier;
                    const opacity = baseOpacity * circle.opacity;
                    
                    // Use soft composition for overlapping
                    skyCtx.globalCompositeOperation = 'multiply';
                    
                    // Create soft gradient for each circle
                    const gradient = skyCtx.createRadialGradient(x, y, 0, x, y, radius);
                    
                    // Main cloud body
                    gradient.addColorStop(0, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, ${opacity})`);
                    gradient.addColorStop(0.4, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, ${opacity * 0.8})`);
                    gradient.addColorStop(0.7, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, ${opacity * 0.4})`);
                    gradient.addColorStop(1, `rgba(${cloudColor[0]}, ${cloudColor[1]}, ${cloudColor[2]}, 0)`);
                    
                    skyCtx.fillStyle = gradient;
                    skyCtx.shadowBlur = 15;
                    skyCtx.shadowColor = `rgba(${shadowColor[0]}, ${shadowColor[1]}, ${shadowColor[2]}, ${opacity * 0.3})`;
                    skyCtx.shadowOffsetY = 5;
                    
                    skyCtx.beginPath();
                    skyCtx.arc(x, y, radius, 0, Math.PI * 2);
                    skyCtx.fill();
                });
                
                // Reset shadow
                skyCtx.shadowBlur = 0;
                skyCtx.shadowOffsetY = 0;
                
                // Move cloud
                cloud.x += cloud.speed;
                if (cloud.x > window.innerWidth + 200) {
                    cloud.x = -200;
                    cloud.y = Math.random() * window.innerHeight * 0.6 + 50;
                }
            }
            
            // Reset composite operation
            skyCtx.globalCompositeOperation = 'source-over';
        }

        // Update weather particles based on current conditions
        function updateWeatherParticles(weatherCode, windDirection) {
            particles = [];
            
            if (weatherCode >= 51 && weatherCode <= 67 || weatherCode >= 80 && weatherCode <= 82) {
                // Rain/drizzle - includes codes 51-53 (drizzle) and 61-67 (rain)
                const particleCount = weatherCode >= 61 ? 100 : 50; // More for rain than drizzle
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        type: 'rain',
                        x: Math.random() * window.innerWidth,
                        y: Math.random() * -window.innerHeight,
                        speed: Math.random() * 5 + 5,
                        windOffset: Math.cos((windDirection || 0) * Math.PI / 180) * 2,
                        length: Math.random() * 15 + 10,
                        opacity: Math.random() * 0.7 + 0.3
                    });
                }
            } else if (weatherCode >= 71 && weatherCode <= 77 || weatherCode >= 85 && weatherCode <= 86) {
                // Snow - codes 71-77
                for (let i = 0; i < 75; i++) {
                    particles.push({
                        type: 'snow',
                        x: Math.random() * window.innerWidth,
                        y: Math.random() * -window.innerHeight,
                        speed: Math.random() * 2 + 0.5,
                        windOffset: Math.cos((windDirection || 0) * Math.PI / 180) * 0.5,
                        size: Math.random() * 4 + 2,
                        opacity: Math.random() * 0.8 + 0.2,
                        rotation: Math.random() * Math.PI * 2,
                        rotationSpeed: (Math.random() - 0.5) * 0.02
                    });
                }
            }
        }

        // Draw weather particles
        function drawWeatherParticles() {
            particlesCtx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
            
            particles.forEach((particle, index) => {
                if (particle.type === 'rain') {
                    particlesCtx.strokeStyle = `rgba(135, 206, 250, ${particle.opacity})`;
                    particlesCtx.lineWidth = 1.5;
                    particlesCtx.beginPath();
                    particlesCtx.moveTo(particle.x, particle.y);
                    particlesCtx.lineTo(particle.x + particle.windOffset, particle.y + particle.length);
                    particlesCtx.stroke();
                    
                    particle.y += particle.speed;
                    particle.x += particle.windOffset * 0.5;
                } else if (particle.type === 'snow') {
                    particlesCtx.fillStyle = `rgba(255, 255, 255, ${particle.opacity})`;
                    particlesCtx.shadowBlur = 2;
                    particlesCtx.shadowColor = 'rgba(255, 255, 255, 0.5)';
                    particlesCtx.beginPath();
                    particlesCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    particlesCtx.fill();
                    particlesCtx.shadowBlur = 0;
                    
                    particle.y += particle.speed;
                    particle.x += particle.windOffset + Math.sin(particle.y * 0.01) * 0.5;
                    particle.rotation += particle.rotationSpeed;
                }
                
                // Remove particles that have fallen off screen
                if (particle.y > window.innerHeight + 50) {
                    particles[index] = {
                        ...particle,
                        y: -50,
                        x: Math.random() * window.innerWidth
                    };
                }
            });
        }

        // Main animation loop
        function startAnimationLoop() {
            function animate() {
                if (weatherData) {
                    let hour;
                    let cloudCover;
                    
                    if (isLiveMode) {
                        const now = new Date();
                        hour = now.getHours() + now.getMinutes() / 60;
                        cloudCover = weatherData.current.cloud_cover;
                    } else {
                        const targetTime = new Date(baseTime.getTime() + selectedHourOffset * 60 * 60 * 1000);
                        hour = targetTime.getHours() + targetTime.getMinutes() / 60;
                        
                        const weatherForOffset = getWeatherForHourOffset(selectedHourOffset);
                        cloudCover = weatherForOffset ? weatherForOffset.cloud_cover : 50;
                    }
                    
                    // Clear canvas
                    skyCtx.clearRect(0, 0, skyCanvas.width, skyCanvas.height);
                    
                    // Draw sky gradient
                    skyCtx.fillStyle = createSkyGradient(hour);
                    skyCtx.fillRect(0, 0, skyCanvas.width / (window.devicePixelRatio || 1), skyCanvas.height / (window.devicePixelRatio || 1));
                    
                    // Draw celestial objects and effects
                    drawStars(hour);
                    drawMoon(hour);
                    drawSun(hour, cloudCover); // Pass cloud cover to hide sun when cloudy
                    drawClouds(hour, cloudCover);
                    
                    // Draw weather particles
                    drawWeatherParticles();
                }
                
                animationFrame = requestAnimationFrame(animate);
            }
            animate();
        }

        // Initialize the app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>